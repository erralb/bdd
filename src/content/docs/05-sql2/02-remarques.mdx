---
title: Compl√©ments sur les jointures
sidebar:
  label: Remarques
---

import Table from "/src/components/TableSQLite.astro";
import Slide from "/src/components/Slide.astro";

<Slide title="Compl√©ments sur les jointures">

La jointure est un op√©rateur fondamental en ce qu'il permet de naviguer parmi les donn√©es. Cependant, il est n√©cessaire de bien comprendre le fonctionnement des jointures pour √©crire des requ√™tes correctes et efficaces.

Nous allons nous int√©resser :

1. √† la pertinence d'utiliser une sous-requ√™te plut√¥t qu'une jointure
2. aux valeurs d√©riv√©es dans une jointure
3. aux jointures g√©n√©ralis√©es
4. √† l'interpr√©tation du r√©sultat d'une jointure

</Slide>
<Slide>

## Sous-requ√™te vs jointure

_Certaines conditions utilisant une sous-requ√™te (SELECT emboit√©) peuvent s'exprimer √† l'aide d'une jointure_

Examinons 2 cas :

1. Le cas des conditions d'association et de non association
2. Le cas de sous-requ√™te et de cl√© √©trang√®re multicomposants

</Slide>
<Slide>

### Equivalence

La requ√™te suivante, qui renvoie les _commandes_ pass√©es par des _clients_ de Grenoble :

```sql
SELECT numero, dateCommande
FROM  Commandes
WHERE  numeroClient IN ( SELECT  numero FROM Clients WHERE ville='Grenoble' ) ;

```

peut s'√©crire √©galement sous la forme d'une jointure :

```sql
SELECT numero, dateCommande
FROM  Commandes C, Clients CL
WHERE  C.numeroClient = CL.numero
AND CL.ville='Grenoble' ;
```

Ou en utilisant la syntaxe `JOIN` :

```sql
SELECT numero, dateCommande
FROM  Commandes C
JOIN Clients CL ON C.numeroClient = CL.numero
WHERE CL.ville='Grenoble' ;
```

</Slide>
<Slide>

### Equivalence

La requ√™te suivante renvoie les _commandes_ qui contiennent un _produit_ dont la quantit√© est inf√©rieure √† la quantit√© command√©e pour le produit num√©ro 1 dans la commande num√©ro 3 :

```sql
SELECT *
FROM Commandes
WHERE numero IN ( SELECT numeroCommande
                  FROM Details
                  WHERE numeroProduit = 1 AND quantite < (SELECT quantite
                                                          FROM Details
                                                          WHERE numeroProduit = 1
                                                          AND numeroCommande = 3) ) ;
```

Cette requ√™te peut √©galement s'√©crire sous la forme de jointures uniquement :

```sql
SELECT DISTINCT C.*
FROM Commandes C, Details D1, Details D2
WHERE C.numero = D1.numeroCommande
AND D1.numeroProduit = 1
AND D2.numeroProduit = 1
AND D2.numeroCommande = 3
AND D1.quantite < D2.quantite ;
```

</Slide>
<Slide>

### Non √©quivalence

Cependant, la requ√™te suivante, qui renvoie les _commandes_ qui ne contiennent pas de _produit_ num√©ro 1 : _(qui pourrait aussi s'√©crire avec un `NOT EXISTS`)_

```sql
SELECT *
FROM Commandes
WHERE numero NOT IN ( SELECT numeroCommande
						          FROM Details WHERE numeroProduit = 1 ) ;
```

:::danger[&nbsp;]
ne peut absolument pas s'√©crire sous la forme d'une jointure !
:::

_Avec une jointure, on ne peut pas exprimer une condition de **non-association**_

Intuitivement, on pourrait penser que la requ√™te suivante serait similaire √† la pr√©c√©dente :

```sql
SELECT *
FROM Commandes C, Details D
WHERE C.numero = D.numeroCommande
AND D.numeroProduit != 1 ;
```

Mais cette requ√™te ne renvoie pas les commandes qui ne contiennent pas le produit num√©ro 1. Elle renvoie les commandes qui contiennent un produit diff√©rent du produit num√©ro 1.

:::tip[√Ä retenir]
Il faut se souvenir, qu'une jointure, fond√©e sur un couple de cl√©s _primaire/√©trang√®re_ permet de mat√©rialiser des associations entre lignes et non **l'inexistence** d'associations.
:::

</Slide>
<Slide>

#### Comparaison des r√©sultats

Pour s'en assurer, comparons les r√©sultats des deux requ√™tes :

<div class="tables-2-col">
  <div>
    <Table
      sqliteDB="public/sample/ecommerce/ecommerce-fr-erd-v2.sqlite"
      title="Commandes"
      showSQL="true"
      query={`
SELECT numero
FROM Commandes
WHERE numero NOT IN ( SELECT numeroCommande 
						          FROM Details 
                      WHERE numeroProduit = 1 ) ;
`}
    />
  </div>
  <div>
    <Table
      sqliteDB="public/sample/ecommerce/ecommerce-fr-erd-v2.sqlite"
      title="Commandes"
      showSQL="true"
      query={`
SELECT C.numero
FROM Commandes C, Details D
WHERE C.numero = D.numeroCommande
AND D.numeroProduit != 1 ;
`}
    />
  </div>
</div>

</Slide>
<Slide title="Conclusion sur les sous-requ√™tes et les jointures">

### Conclusion

1. La **jointure et la sous-requ√™te** permettent d'exprimer des **conditions d'association** entre lignes

2. _En revanche_, des **conditions de non-association** ne sont g√©n√©ralement exprimables que par des **sous-requ√™tes**, ainsi que par la forme `NOT EXISTS`

</Slide>
<Slide>

## Calculs sur les jointures

Une jointure permet √©galement d'effectuer des **calculs** sur des quantit√©s extraites de plusieurs tables

Le raisonnement est simple : la jointure constitue des lignes fictives, dont la clause `SELECT` extrait des valeurs comme elle le ferait d'une ligne r√©elle issue d'une table

Par exemple, la requ√™te suivant associe √† chaque ligne de `Details` le montant √† payer pour la commande num√©ro 1:

<Table
  sqliteDB="public/sample/ecommerce/ecommerce-fr-erd-v2.sqlite"
  title="Commandes"
  showSQL="true"
  query={`
SELECT D.numeroCommande, D.numeroProduit, D.quantite, D.quantite * P.prix AS 'Montant'
FROM Details D, Produits P
WHERE D.numeroProduit = P.numero
AND D.numeroCommande = 1 ;
`}
/>

</Slide>
<Slide>

La requ√™te suivante, elle, √©tablit le montant de la commande num√©ro 1 :

<Table
  sqliteDB="public/sample/ecommerce/ecommerce-fr-erd-v2.sqlite"
  title="Commandes"
  showSQL="true"
  query={`
SELECT D.numeroCommande, SUM(D.quantite * P.prix) AS 'Montant total'
FROM Details D, Produits P
WHERE D.numeroProduit = P.numero
AND D.numeroCommande = 1 ;
`}
/>

</Slide>
<Slide>

## Autres conditions de jointures

Les conditions de jointures pr√©sent√©es jusqu'ici √©taient fond√©es sur **l'√©galit√© des valeurs d'une cl√© √©trang√®re avec celles d'un identifiant**

Toutefois, toute comparaison peut servir √† indiquer comment associer les lignes des tables concern√©es.

</Slide>
<Slide title="Autres conditions de jointures">

L'exemple ci-dessous illustre une op√©ration fr√©quente qui consiste √† condenser de l'information de mani√®re √† la rendre plus lisible.

La table ci-dessous √©tablit des intervalles successifs de valeurs de compte (minimum et maximum sur le compte) et leur attribut un code de classe de compte.

<Table
  sqliteDB="public/sample/ecommerce/ecommerce-fr-erd-v2.sqlite"
  title="Classes_Comptes"
  query={`
SELECT * FROM Classes_Comptes ;
`}
/>

</Slide>
<Slide>

Comment associer √† chaque client le code de son compte ?

La requ√™te suivante permet de r√©aliser cette op√©ration :

<Table
  sqliteDB="public/sample/ecommerce/ecommerce-fr-erd-v2.sqlite"
  title="Classes de comptes des clients"
  showSQL="true"
  query={`
  SELECT numero, nom, compte, codeCompte
  FROM Clients, Classes_Comptes
  WHERE compte >= minimumCompte
  AND compte < maximumCompte ;
`}
/>

</Slide>
<Slide>

## Compr√©hension du r√©sultat d'une jointure

La construction d'une requ√™te qui utilise une ou plusieurs jointures peut s'av√©rer d√©licate.

Il est important de bien comprendre ce que repr√©sente le r√©sultat d'une jointure.

</Slide>
<Slide>

La question est la suivante : sachant que toute ligne d'une table repr√©sente une entit√© du domaine d'application (un client, un achat, un d√©tail, etc.), quelles entit√©s les lignes d'une jointure repr√©sentent-elles ?

Par exemple, chaque ligne produite par l'√©valuation de la requ√™te :

```sql
SELECT C.numero, C.nom, C.ville
FROM Clients C, Commandes Co
WHERE C.numero = Co.numeroClient ;
```

repr√©sente-t-elle :

1. un client ?
2. un client qui a pass√© une ou plusieurs commandes ?
3. une commande ?

R√©ponse : **des commandes**

</Slide>
<Slide>

### R√®gle g√©n√©rale

La r√®gle relative √† une jointure √©l√©mentaire, fond√©e sur l'√©galit√© identifiant / cl√© √©trang√®re est simple :

:::tip[R√®gle]
Soit :

- une table `TA`, d'identifiant `IA`, et des colonnes `DA`
- une table `TB`, d'identifiant `IB`, avec une colonne `RA` cl√© √©trang√®re _obligatoire_ et r√©f√©ren√ßant `TA`, et des colonnes `DB`

```ansi wrap frame="none"
[1mTA[0m ([4mIA[0m, DA)
[1mTB[0m ([4mIB[0m, RA*, DB)
```

Le r√©sultat de la requ√™te :

```sql
SELECT *
FROM TA, TB
WHERE TA.IA = TB.RA ;
```

contient autant de lignes qu'il y en a dans la table TB.

Autrement dit, chaque ligne du r√©sultat d'une jointure repr√©sente une ligne de TB
:::

En bref : le r√©sultat d'une jointure repr√©sente des entit√©s de la table **contenant la cl√© √©trang√®re**

</Slide>
<Slide>

##### Exemple :

Soit la requ√™te suivante :

```sql
SELECT Co.numero, Co.dateCommande, Co.numeroClient
FROM Commandes Co, Details D
WHERE Co.numero = D.numeroCommande ;
```

La cl√© √©trang√®re de `Details` est `numeroCommande`, qui r√©f√©rence `Commandes`.

Le r√©sultat de cette requ√™te repr√©sente donc des d√©tails.

</Slide>
<Slide>

## Identifiant de la jointure

Ce que nous venons de discuter conduit √† une autre r√®gle : **l'identifiant du r√©sultat de la jointure**

```sql
SELECT *
FROM TA, TB
WHERE TA.IA = TB.RA ;
```

est constitu√© des colonnes de l'identifiant primaire de `TB` (soit `IB`)

Si l'identifiant primaire de `TB` n'est pas repris dans la s√©lection des colonnes, _le r√©sultat n'a pas d'identifiant_.

Exemple :

<Table
  sqliteDB="public/sample/ecommerce/ecommerce-fr-erd-v2.sqlite"
  title="Classes de comptes des clients"
  showSQL="true"
  query={`
SELECT C.ville, P.nom
FROM Clients C, Commandes Co, Details D, Produits P
WHERE C.numero = Co.numeroClient
AND Co.numero = D.numeroCommande
AND D.numeroProduit = P.numero ;
`}
/>

</Slide>
<Slide>

## Conclusion

- La jointure est un op√©rateur fondamental en SQL, qui permet de naviguer parmi les donn√©es.
- Les jointures permettent d'effectuer des calculs sur des quantit√©s extraites de plusieurs tables.
- Il est n√©cessaire de bien comprendre le fonctionnement des jointures pour √©crire des requ√™tes correctes et efficaces.
- Les jointures permettent d'exprimer des conditions d'association entre lignes.
  - Les sous-requ√™tes permettent d'exprimer des conditions de non-association.
- Il est important de bien comprendre ce que repr√©sente le r√©sultat d'une jointure.

</Slide>
